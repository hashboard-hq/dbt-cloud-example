name: Deploy DBT and Hashboard

on:
  push:
    branches: [main]

jobs:
  dbt-cloud-run:
    runs-on: ubuntu-latest
    env:
      DBT_ACCOUNT_ID: 21999
      DBT_JOB_ID: 740532
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Trigger DBT Cloud Deployment
        id: trigger-job
        run: |
          response=$(curl -X POST -s -w "\n%{http_code}" -H "Authorization: Token ${{ secrets.DBT_CLOUD_API_KEY }}" \
                       -H "Content-Type: application/json" \
                       "https://cloud.getdbt.com/api/v2/accounts/$DBT_ACCOUNT_ID/jobs/$DBT_JOB_ID/run/" \
                       -d '{"cause": "Production deploy from GitHub Action"}')

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ $http_code -ne 200 ]; then
            echo "Error: Received HTTP status code $http_code"
            echo "Response body: $body"
            exit 1
          fi

          job_id=$(echo $body | jq -r '.data.id')
          if [ -z "$job_id" ] || [ "$job_id" = "null" ]; then
            echo "Error: Failed to extract job ID from response"
            echo "Response body: $body"
            exit 1
          fi

          echo "JOB_ID=$job_id" >> $GITHUB_OUTPUT

      - name: "Install Python 3.9"
        id: install-python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Hashboard CLI
        run: |
          pip install dbt
          pip install --pre hashboard-cli

      - name: Wait for DBT Cloud Job to complete and artifacts to be saved
        run: |
          job_id=${{ steps.trigger-job.outputs.JOB_ID }}
          while true; do
            response=$(curl -s -w "\n%{http_code}" -H "Authorization: Token ${{ secrets.DBT_CLOUD_API_KEY }}" \
                        "https://cloud.getdbt.com/api/v2/accounts/$DBT_ACCOUNT_ID/runs/$job_id/")

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            if [ $http_code -ne 200 ]; then
              echo "Error: Received HTTP status code $http_code when checking job status"
              echo "Response body: $body"
              exit 1
            fi

            status=$(echo $body | jq -r '.data.status')
            artifacts_saved=$(echo $body | jq -r '.data.artifacts_saved')

            if [ "$status" = "10" ] && [ "$artifacts_saved" = "true" ]; then
              echo "Job completed successfully and artifacts are saved"
              break
            elif [ "$status" = "10" ]; then
              echo "Job completed successfully, waiting for artifacts to be saved..."
            elif [ "$status" = "20" ]; then
              echo "Error: dbt run failed"
              exit 1
            elif [ "$status" = "30" ]; then
              echo "Error: dbt run was cancelled"
              exit 1
            elif [ "$status" = "3" ]; then
              echo "Job still running, waiting 5 seconds..."
            else
              echo "Unknown dbt run status code $status"
              exit 1
            fi

            sleep 5
          done

      - name: Create artifacts directory
        run: mkdir ci_artifacts

      - name: Download manifest
        run: |
          response=$(curl -s -w "\n%{http_code}" --request GET \
               -H "Authorization: Token ${{ secrets.DBT_CLOUD_API_KEY }}" \
               "https://cloud.getdbt.com/api/v2/accounts/$DBT_ACCOUNT_ID/runs/${{ steps.trigger-job.outputs.JOB_ID }}/artifacts/manifest.json")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          if [ $http_code -ne 200 ]; then
            echo "Error: Received HTTP status code $http_code when downloading manifest"
            echo "Response body: $body"
            exit 1
          fi

          echo "$body" > ci_artifacts/manifest.json

      - name: Create and apply Hashboard build
        id: create-hb-build
        env:
          HASHBOARD_PROJECT_ID: ${{ secrets.HASHBOARD_PROJECT_ID }}
          HASHBOARD_ACCESS_KEY_ID: ${{ secrets.HASHBOARD_ACCESS_KEY_ID }}
          HASHBOARD_SECRET_ACCESS_KEY_TOKEN: ${{ secrets.HASHBOARD_ACCESS_KEY_TOKEN }}
          HASHBOARD_CLI_BASE_URI: https://demo.hashboard.com  # Remove this for non-demo actions
        run: |
          hb build  --dbt-artifacts=./ci_artifacts && hb build apply --no-confirm
